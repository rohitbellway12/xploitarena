// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(RESEARCHER)
  isActive     Boolean  @default(true) @map("is_active")
  isVerified   Boolean  @default(false) @map("is_verified")

  // Relations
  programs     Program[] @relation("CompanyPrograms")
  invitedPrograms Program[] @relation("ProgramInvitations")
  reports      Report[]  @relation("ResearcherReports")
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[]
  companyMembers CompanyMember[] @relation("CompanyMembership")
  ownedCompanies CompanyMember[] @relation("CompanyOwner")
  files          File[]

  mfaSecret       String?   @map("mfa_secret")
  mfaEnabled      Boolean   @default(false) @map("mfa_enabled")
  twoFactorCode   String?   @map("two_factor_code")
  twoFactorExpires DateTime? @map("two_factor_expires")
  googleId        String?   @unique @map("google_id")
  githubId        String?   @unique @map("github_id")
  loginAttempts   Int       @default(0) @map("login_attempts")
  lockedUntil     DateTime? @map("locked_until")
  resetToken      String?   @map("reset_token")
  resetTokenExpires DateTime? @map("reset_token_expires")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

enum Role {
  RESEARCHER
  COMPANY_ADMIN
  TRIAGER
  ADMIN
  SUPER_ADMIN
}

model Program {
  id          String        @id @default(cuid())
  name        String
  description String
  scope       String        @db.Text
  rules       String?       @db.Text
  rewards     String        // e.g., "$100 - $5000"
  status      ProgramStatus @default(ACTIVE)
  type        ProgramType   @default(PUBLIC)
  companyId   String        @map("company_id")
  budgetTotal Float?        @map("budget_total")
  budgetSpent Float         @default(0) @map("budget_spent")
  lowBudgetAlertSent Boolean @default(false) @map("low_budget_alert_sent")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  company     User          @relation("CompanyPrograms", fields: [companyId], references: [id])
  invitedResearchers User[] @relation("ProgramInvitations")
  reports     Report[]

  @@map("programs")
}

enum ProgramStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum ProgramType {
  PUBLIC
  PRIVATE
}

model Report {
  id           String       @id @default(cuid())
  title        String
  description  String       @db.Text
  asset        String?      // The URL or host affected
  category     String?      // e.g., SQLi, XSS
  severity     Severity
  cvss         Float?       // CVSS Score
  impact       String?      @db.Text
  status       ReportStatus @default(SUBMITTED)
  bountyAmount Float?       @map("bounty_amount")
  programId    String       @map("program_id")
  researcherId String       @map("researcher_id")
  submittedAt  DateTime     @default(now()) @map("submitted_at")
  triagedAt    DateTime?    @map("triaged_at")
  resolvedAt   DateTime?    @map("resolved_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  program      Program      @relation(fields: [programId], references: [id])
  researcher   User         @relation("ResearcherReports", fields: [researcherId], references: [id])
  auditLogs    AuditLog[]
  files        File[]

  @@map("reports")
}

model File {
  id         String   @id @default(cuid())
  filename   String
  path       String   // Path on disk or S3 Key
  mimetype   String
  size       Int
  uploaderId String   @map("uploader_id")
  reportId   String?  @map("report_id") // Optional, can be linked later
  createdAt  DateTime @default(now()) @map("created_at")

  uploader   User     @relation(fields: [uploaderId], references: [id])
  report     Report?  @relation(fields: [reportId], references: [id])

  @@map("files")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])
  @@map("refresh_tokens")
}

model CompanyMember {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  userId    String   @map("user_id")
  role      String   @default("MEMBER") // ADMIN, MEMBER
  createdAt DateTime @default(now()) @map("created_at")

  company   User     @relation("CompanyOwner", fields: [companyId], references: [id])
  user      User     @relation("CompanyMembership", fields: [userId], references: [id])

  @@unique([companyId, userId])
  @@map("company_members")
}

model Event {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  scope       String?  @db.Text
  rewards     String?
  isPrivate   Boolean  @default(false) @map("is_private")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("events")
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  NEED_INFO
  TRIAGING
  DUPLICATE
  REJECTED
  ACCEPTED
  IN_PROGRESS
  IN_REVIEW
  RESOLVED
  READY_FOR_PAYOUT
  PAID
  CLOSED
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // e.g., "AUTH_LOGIN", "REPORT_STATUS_CHANGE"
  details   String?  @db.Text
  ipAddress String?  @map("ip_address")
  userId    String?  @map("user_id")
  reportId  String?  @map("report_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User?    @relation(fields: [userId], references: [id])
  report    Report?  @relation(fields: [reportId], references: [id])

  @@map("audit_logs")
}